<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ADMIN SHOP - FIX LỖI KẾT NỐI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; background: #0f172a; color: #e2e8f0; }
        .card { background: #1e293b; border: 1px solid #334155; border-radius: 12px; }
        .status-online { color: #10b981; }
        .status-offline { color: #ef4444; }
        .debug-box { background: #000; font-family: monospace; color: #00ff00; padding: 10px; border-radius: 5px; font-size: 11px; max-height: 150px; overflow-y: auto; }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-5xl mx-auto">
        <!-- Dashboard Header -->
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
            <div>
                <h1 class="text-3xl font-black text-white italic">ADMIN <span class="text-blue-500">CONTROL</span></h1>
                <p class="text-slate-400 text-sm">Hệ thống đồng bộ dữ liệu Realtime</p>
            </div>
            <div id="connection-status" class="bg-slate-800 px-4 py-2 rounded-full text-xs font-bold border border-slate-700">
                <i class="fas fa-circle mr-2"></i> ĐANG KIỂM TRA KẾT NỐI...
            </div>
        </div>

        <!-- Debugging Helper (Dành cho chủ shop kiểm tra lỗi) -->
        <div class="card p-4 mb-6 border-l-4 border-yellow-500">
            <h2 class="text-sm font-bold mb-2 text-yellow-500"><i class="fas fa-bug mr-2"></i>TRÌNH KIỂM TRA ĐƯỜNG DẪN (DEBUG)</h2>
            <p class="text-[11px] text-slate-400 mb-2 italic">* Nếu bạn bấm mua mà không hiện, hãy nhìn vào ô bên dưới xem tên "nhánh" nào vừa xuất hiện.</p>
            <div id="debug-log" class="debug-box">
                [Hệ thống]: Đang lắng nghe thay đổi trên toàn bộ Database...
            </div>
        </div>

        <!-- Tabs -->
        <div class="flex gap-2 mb-6">
            <button onclick="showTab('bank')" id="btn-bank" class="px-6 py-2 rounded-lg bg-blue-600 text-white font-bold text-sm">NẠP TIỀN</button>
            <button onclick="showTab('orders')" id="btn-orders" class="px-6 py-2 rounded-lg bg-slate-800 text-slate-400 font-bold text-sm">ĐƠN HÀNG</button>
        </div>

        <!-- Content Bank -->
        <div id="tab-bank">
            <div id="list-bank" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="col-span-full text-center py-10 text-slate-500">Đang tải dữ liệu nạp tiền...</div>
            </div>
        </div>

        <!-- Content Orders -->
        <div id="tab-orders" class="hidden">
            <div id="list-orders" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="col-span-full text-center py-10 text-slate-500">Đang tải dữ liệu đơn hàng...</div>
            </div>
        </div>
    </div>

    <script>
        // 1. CẤU HÌNH (THAY DATABASE CỦA BẠN VÀO ĐÂY)
        const firebaseConfig = {
            databaseURL: "https://shop-blox-fruit-trannghia-default-rtdb.firebaseio.com/"
        };
        
        // 2. WEBHOOK DISCORD
        const DISCORD_WEBHOOK = "https://discord.com/api/webhooks/1471073517863702570/w-6BHDb9CwxlG_XMYeqqnoWcqmv3kPrG8H2SepceylI7ei1zrsDWKyKTo0S7k9BGUwgD";

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // Kiểm tra kết nối
        db.ref(".info/connected").on("value", (snap) => {
            const el = document.getElementById('connection-status');
            if (snap.val() === true) {
                el.innerHTML = '<i class="fas fa-circle mr-2 status-online"></i> DATABASE: ĐÃ KẾT NỐI';
                el.className = "bg-slate-800 px-4 py-2 rounded-full text-xs font-bold border border-emerald-900 text-emerald-400";
            } else {
                el.innerHTML = '<i class="fas fa-circle mr-2 status-offline"></i> DATABASE: MẤT KẾT NỐI';
                el.className = "bg-slate-800 px-4 py-2 rounded-full text-xs font-bold border border-red-900 text-red-400";
            }
        });

        // 3. HÀM DEBUG TỰ ĐỘNG (RẤT QUAN TRỌNG)
        // Hàm này sẽ theo dõi toàn bộ Database, nếu có bất kỳ thay đổi nào nó sẽ in ra tên nhánh đó.
        db.ref().on('child_changed', (snapshot) => {
            logDebug(`Nhánh [${snapshot.key}] vừa có thay đổi dữ liệu!`);
        });
        db.ref().on('child_added', (snapshot) => {
            logDebug(`Nhánh mới xuất hiện: [${snapshot.key}]`);
        });

        function logDebug(msg) {
            const log = document.getElementById('debug-log');
            const now = new Date().toLocaleTimeString();
            log.innerHTML += `<div>[${now}] ${msg}</div>`;
            log.scrollTop = log.scrollHeight;
        }

        // 4. LẮNG NGHE DỮ LIỆU
        // Thử lắng nghe nhiều nhánh phổ biến nếu nhánh chính không có
        const bankPaths = ['requests', 'naptien', 'napthe', 'bank_logs'];
        const orderPaths = ['orders', 'donhang', 'muado', 'history'];

        function loadData(paths, containerId, type) {
            paths.forEach(path => {
                db.ref(path).on('value', (snapshot) => {
                    const data = snapshot.val();
                    if(data) {
                        logDebug(`Đã tìm thấy dữ liệu tại nhánh: ${path}`);
                        renderUI(data, containerId, type, path);
                    }
                });
            });
        }

        function renderUI(data, containerId, type, pathName) {
            const container = document.getElementById(containerId);
            container.innerHTML = "";
            
            Object.keys(data).reverse().forEach(key => {
                const item = data[key];
                if(type === 'bank') {
                    container.innerHTML += `
                        <div class="card p-5 border-l-4 border-emerald-500 shadow-lg">
                            <div class="flex justify-between items-start mb-4">
                                <div>
                                    <h3 class="font-black text-white">@${item.user || 'User'}</h3>
                                    <p class="text-[10px] text-slate-500 uppercase font-bold">Nhánh: ${pathName}</p>
                                </div>
                                <span class="text-emerald-400 font-black text-xl">${Number(item.amount).toLocaleString()}đ</span>
                            </div>
                            <div class="bg-black/30 p-2 rounded text-xs mb-4 text-slate-300">ND: ${item.memo || 'Trống'}</div>
                            <button onclick="approveBank('${item.user}', ${item.amount}, '${key}', '${pathName}')" class="w-full bg-emerald-600 hover:bg-emerald-500 text-white font-black py-2 rounded-lg transition-all text-sm">XÁC NHẬN NẠP</button>
                        </div>
                    `;
                } else {
                    container.innerHTML += `
                        <div class="card p-5 border-l-4 border-blue-500 shadow-lg">
                            <div class="flex justify-between items-start mb-4">
                                <div>
                                    <h3 class="font-black text-white">${item.item || 'Sản phẩm'}</h3>
                                    <p class="text-[10px] text-slate-500 font-bold">Khách: @${item.user}</p>
                                </div>
                                <span class="bg-blue-900/50 text-blue-400 text-[10px] px-2 py-1 rounded font-bold">${item.status || 'Chờ xử lý'}</span>
                            </div>
                            <div class="bg-black/30 p-3 rounded text-xs font-mono mb-4 text-blue-200 break-all">${item.info || 'Không có info'}</div>
                            <div class="flex gap-2">
                                <button onclick="completeOrder('${key}', '${pathName}')" class="flex-1 bg-blue-600 text-white font-black py-2 rounded-lg text-sm">HOÀN TẤT</button>
                                <button onclick="deleteItem('${key}', '${pathName}')" class="px-4 bg-slate-700 text-slate-400 rounded-lg"><i class="fas fa-trash"></i></button>
                            </div>
                        </div>
                    `;
                }
            });
        }

        // 5. CÁC HÀM XỬ LÝ
        async function approveBank(username, amount, key, path) {
            if(!confirm(`Cộng ${amount}đ cho ${username}?`)) return;
            try {
                // Cộng tiền cho user (Giả định nhánh user là 'users/tên_user')
                const userRef = db.ref('users/' + username);
                const snap = await userRef.once('value');
                const curBalance = (snap.val()?.balance) || 0;
                await userRef.update({ balance: curBalance + Number(amount) });
                
                // Xóa yêu cầu
                await db.ref(path + '/' + key).remove();
                alert("Đã duyệt thành công!");
                
                // Gửi Discord
                sendDiscord(`✅ NẠP TIỀN THÀNH CÔNG\nNgười dùng: ${username}\nSố tiền: ${amount}đ`);
            } catch(e) { alert("Lỗi: " + e.message); }
        }

        async function completeOrder(key, path) {
            await db.ref(path + '/' + key).update({ status: 'Hoàn thành' });
            alert("Đã xong đơn!");
        }

        async function deleteItem(key, path) {
            if(confirm("Xóa vĩnh viễn?")) await db.ref(path + '/' + key).remove();
        }

        async function sendDiscord(msg) {
            if(!DISCORD_WEBHOOK.includes("http")) return;
            fetch(DISCORD_WEBHOOK, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ content: msg })
            });
        }

        function showTab(type) {
            document.getElementById('tab-bank').classList.toggle('hidden', type !== 'bank');
            document.getElementById('tab-orders').classList.toggle('hidden', type !== 'orders');
            document.getElementById('btn-bank').className = type === 'bank' ? "px-6 py-2 rounded-lg bg-blue-600 text-white font-bold text-sm" : "px-6 py-2 rounded-lg bg-slate-800 text-slate-400 font-bold text-sm";
            document.getElementById('btn-orders').className = type === 'orders' ? "px-6 py-2 rounded-lg bg-blue-600 text-white font-bold text-sm" : "px-6 py-2 rounded-lg bg-slate-800 text-slate-400 font-bold text-sm";
        }

        // Khởi chạy
        loadData(bankPaths, 'list-bank', 'bank');
        loadData(orderPaths, 'list-orders', 'orders');

    </script>
</body>
</html>
