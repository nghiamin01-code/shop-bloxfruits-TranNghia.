<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ADMIN DASHBOARD - DUYỆT NẠP</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #0b0e14; color: #e2e8f0; }
        .glass { background: rgba(23, 27, 34, 0.8); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.05); }
        .btn-approve { background: linear-gradient(135deg, #10b981 0%, #059669 100%); transition: 0.2s; }
        .btn-approve:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3); }
        .item-card { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
    </style>
</head>
<body class="min-h-screen pb-10">

    <!-- Header -->
    <nav class="glass sticky top-0 z-50 p-4 mb-6 border-b border-white/5">
        <div class="max-w-5xl mx-auto flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-emerald-500/20 rounded-xl flex items-center justify-center">
                    <i class="fas fa-shield-alt text-emerald-500"></i>
                </div>
                <h1 class="text-xl font-extrabold tracking-tight">ADMIN PANEL</h1>
            </div>
            <div class="flex gap-4">
                <div class="px-4 py-2 bg-emerald-500/10 rounded-lg text-emerald-500 text-xs font-bold">
                    ONLINE: <span id="pending-badge">0</span> ĐƠN
                </div>
            </div>
        </div>
    </nav>

    <main class="max-w-xl mx-auto px-4">
        <!-- Dashboard Stats -->
        <div class="grid grid-cols-2 gap-4 mb-8">
            <div class="glass p-4 rounded-2xl">
                <p class="text-slate-500 text-[10px] font-bold uppercase mb-1">Tổng tiền đã duyệt</p>
                <h2 id="total-approved" class="text-xl font-black text-white">0đ</h2>
            </div>
            <div class="glass p-4 rounded-2xl border-l-4 border-emerald-500">
                <p class="text-slate-500 text-[10px] font-bold uppercase mb-1">Hôm nay</p>
                <h2 id="today-count" class="text-xl font-black text-white">0</h2>
            </div>
        </div>

        <!-- Pending List -->
        <div class="space-y-4">
            <h3 class="text-sm font-bold text-slate-400 flex items-center gap-2 mb-4">
                <i class="fas fa-spinner fa-spin text-emerald-500"></i>
                ĐƠN ĐANG CHỜ (TỰ MẤT KHI XONG)
            </h3>
            
            <div id="list-pending" class="space-y-3">
                <!-- Data from Firebase -->
                <div class="text-center py-10 text-slate-600">
                    <i class="fas fa-satellite-dish mb-2 text-2xl"></i>
                    <p class="text-sm">Đang đợi kết nối dữ liệu...</p>
                </div>
            </div>
        </div>
    </main>

    <script>
        // Cấu hình Firebase - Phải giống hệt trang của User
        const firebaseConfig = { databaseURL: "https://shop-blox-fruit-trannghia-default-rtdb.firebaseio.com/" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let approvedTotal = 0;
        let todayProcessed = 0;

        // Lắng nghe dữ liệu nạp tiền (Collection: 'topups' hoặc 'requests')
        // Lưu ý: Tôi đang dùng 'requests' theo yêu cầu trước, hãy đảm bảo User gửi vào 'requests'
        db.ref('requests').on('value', (snapshot) => {
            const data = snapshot.val();
            const listContainer = document.getElementById('list-pending');
            const badge = document.getElementById('pending-badge');
            
            if (!data) {
                listContainer.innerHTML = `
                    <div class="glass p-10 rounded-3xl text-center border-dashed border-white/10">
                        <p class="text-slate-500 text-sm">Hiện tại không có đơn nào cần xử lý.</p>
                    </div>
                `;
                badge.innerText = "0";
                return;
            }

            // Lọc ra các đơn có status = 'pending' hoặc chưa có status
            const pendingOrders = Object.entries(data)
                .map(([id, val]) => ({ id, ...val }))
                .filter(order => !order.status || order.status === 'pending');

            badge.innerText = pendingOrders.length;
            listContainer.innerHTML = "";

            pendingOrders.reverse().forEach(order => {
                const card = document.createElement('div');
                card.className = "item-card glass p-5 rounded-2xl flex justify-between items-center";
                card.innerHTML = `
                    <div class="flex-1">
                        <div class="flex items-center gap-2 mb-1">
                            <span class="text-[10px] font-black bg-blue-500/20 text-blue-400 px-2 py-0.5 rounded uppercase">User</span>
                            <span class="text-sm font-bold text-white">${order.user || 'Ẩn danh'}</span>
                        </div>
                        <div class="text-2xl font-black text-emerald-400">
                            ${Number(order.amount || 0).toLocaleString()}đ
                        </div>
                        <div class="text-[10px] text-slate-500 uppercase tracking-tighter mt-1">
                            ${new Date(order.timestamp).toLocaleString('vi-VN')}
                        </div>
                    </div>
                    <button onclick="handleApprove('${order.id}', '${order.user}', ${order.amount})" 
                            class="btn-approve h-12 px-6 rounded-xl text-white font-bold text-sm">
                        DUYỆT
                    </button>
                `;
                listContainer.appendChild(card);
            });
        });

        async function handleApprove(orderId, username, amount) {
            try {
                // 1. Tìm user để cộng tiền
                const userRef = db.ref('users/' + username);
                const userSnap = await userRef.once('value');
                const userData = userSnap.val();

                if (!userData) {
                    alert("Lỗi: Không tìm thấy Username '" + username + "' trong hệ thống để cộng tiền!");
                    return;
                }

                // 2. Thực hiện cộng tiền vào số dư (balance)
                const currentBalance = Number(userData.balance || 0);
                const newBalance = currentBalance + Number(amount);
                
                await userRef.update({ balance: newBalance });

                // 3. Cập nhật trạng thái đơn hàng thành 'completed'
                // Khi update xong, lệnh .on('value') ở trên sẽ tự chạy lại và đơn này sẽ biến mất
                await db.ref('requests/' + orderId).update({
                    status: 'completed',
                    processedAt: Date.now()
                });

                // 4. Cập nhật thống kê tạm thời trên màn hình admin
                approvedTotal += amount;
                todayProcessed += 1;
                document.getElementById('total-approved').innerText = approvedTotal.toLocaleString() + 'đ';
                document.getElementById('today-count').innerText = todayProcessed;

            } catch (error) {
                console.error(error);
                alert("Đã xảy ra lỗi khi duyệt đơn!");
            }
        }
    </script>
</body>
</html>
