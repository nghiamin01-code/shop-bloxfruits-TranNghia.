<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>ADIM NGHĨA - DUYỆT THẺ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
</head>
<body class="bg-slate-900 text-white p-5">
    <h1 class="text-2xl font-black text-blue-500 mb-6">QUẢN LÝ NẠP THẺ</h1>
    
    <div class="overflow-x-auto">
        <table class="w-full bg-slate-800 rounded-lg overflow-hidden">
            <thead class="bg-blue-600">
                <tr>
                    <th class="p-3 text-left">Khách hàng</th>
                    <th class="p-3 text-left">Thông tin thẻ</th>
                    <th class="p-3 text-left">Hành động</th>
                </tr>
            </thead>
            <tbody id="admin-list-the"></tbody>
        </table>
    </div>

    <script>
        // ... (Dán Firebase Config của bạn vào đây)
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        db.ref('napthe').on('value', (snapshot) => {
            const list = document.getElementById('admin-list-the');
            list.innerHTML = '';
            snapshot.forEach((child) => {
                const data = child.val();
                if(data.status === 'pending') {
                    list.innerHTML += `
                    <tr class="border-b border-slate-700">
                        <td class="p-3">
                            <b class="text-blue-400">${data.username}</b><br>
                            <span class="text-xs text-slate-400">${new Date(data.time).toLocaleString()}</span>
                        </td>
                        <td class="p-3">
                            <b>${data.loai} - ${data.menhGia.toLocaleString()}đ</b><br>
                            <span class="text-xs">S: ${data.seri}</span><br>
                            <span class="text-xs">M: ${data.pin}</span>
                        </td>
                        <td class="p-3 flex gap-2">
                            <button onclick="duyet('${child.key}', '${data.uid}', ${data.menhGia})" class="bg-green-600 px-3 py-1 rounded font-bold">DUYỆT (+)</button>
                            <button onclick="huy('${child.key}')" class="bg-red-600 px-3 py-1 rounded font-bold">HỦY (X)</button>
                        </td>
                    </tr>`;
                }
            });
        });

        async function duyet(key, uid, menhGia) {
            if(confirm("Xác nhận cộng tiền cho khách?")) {
                const thucNhan = menhGia * 0.8; // Thuế 20%
                const balRef = db.ref('users/' + uid + '/balance');
                
                // Lấy tiền hiện tại và cộng thêm
                const current = (await balRef.get()).val() || 0;
                await balRef.set(current + thucNhan);
                
                // Cập nhật trạng thái thẻ
                await db.ref('napthe/' + key).update({status: 'done'});
                alert("Đã cộng " + thucNhan.toLocaleString() + "đ!");
            }
        }

        async function huy(key) {
            if(confirm("Hủy thẻ này (do sai mã)?")) {
                await db.ref('napthe/' + key).update({status: 'error'});
            }
        }
    </script>
</body>
</html>
