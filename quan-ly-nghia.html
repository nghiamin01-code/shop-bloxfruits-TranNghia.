<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>DUYỆT BANK NHANH - BAP SHOP</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@400;700;900&display=swap');
        body { font-family: 'Outfit', sans-serif; background: #f8fafc; }
    </style>
</head>
<body class="p-6">
    <div class="max-w-2xl mx-auto">
        <h1 class="text-2xl font-black text-slate-800 mb-6 uppercase">Quản lý duyệt Bank</h1>
        
        <div id="bank-list" class="space-y-4">
            <p class="text-slate-400">Đang đợi khách báo bank...</p>
        </div>
    </div>

    <script>
        const firebaseConfig = { 
            apiKey: "AIzaSyA5wBS88oS54yLs0OfwDYDfDQeTjc6ccdM", 
            authDomain: "shop-blox-fruit-trannghia.firebaseapp.com", 
            projectId: "shop-blox-fruit-trannghia", 
            databaseURL: "https://shop-blox-fruit-trannghia-default-rtdb.firebaseio.com" 
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // Lấy danh sách khách báo bank
        db.ref('duyet_bank').on('value', (snapshot) => {
            const list = document.getElementById('bank-list');
            list.innerHTML = '';
            
            snapshot.forEach((child) => {
                const data = child.val();
                if (data.status === 'pending') {
                    list.innerHTML += `
                        <div class="bg-white p-5 rounded-2xl shadow-sm border-2 border-slate-100 flex justify-between items-center">
                            <div>
                                <p class="text-xs text-slate-400 font-bold uppercase tracking-widest">Khách hàng</p>
                                <p class="font-black text-lg text-slate-800">${data.username.toUpperCase()}</p>
                                <p class="text-pink-600 font-black">Số tiền: ${data.amount.toLocaleString()}đ</p>
                            </div>
                            <button onclick="approve('${child.key}', '${data.uid}', ${data.amount})" 
                                class="bg-blue-600 hover:bg-green-600 text-white px-6 py-3 rounded-xl font-black text-xs uppercase transition-all shadow-lg shadow-blue-200">
                                XÁC NHẬN (+ TIỀN)
                            </button>
                        </div>
                    `;
                }
            });
            if (list.innerHTML === '') list.innerHTML = '<p class="text-center text-slate-400 py-10 font-bold">Hiện chưa có ai báo chuyển khoản.</p>';
        });

        // Hàm xử lý cộng tiền tự động khi Nghĩa bấm nút
        async function approve(orderKey, userUid, amount) {
            if (confirm("Nghĩa đã thấy tiền trong App Agribank chưa? Bấm OK để cộng tiền cho khách.")) {
                try {
                    const userRef = db.ref('users/' + userUid + '/balance');
                    
                    // Lấy số dư hiện tại của khách
                    const snapshot = await userRef.get();
                    const currentBalance = snapshot.val() || 0;
                    
                    // 1. Cộng tiền vào ví khách
                    await userRef.set(currentBalance + amount);
                    
                    // 2. Đổi trạng thái đơn sang thành công để biến mất khỏi danh sách chờ
                    await db.ref('duyet_bank/' + orderKey).update({ status: 'success' });
                    
                    alert("Thành công! Đã cộng " + amount.toLocaleString() + "đ vào tài khoản khách.");
                } catch (e) {
                    alert("Lỗi: " + e.message);
                }
            }
        }
    </script>
</body>
</html>
