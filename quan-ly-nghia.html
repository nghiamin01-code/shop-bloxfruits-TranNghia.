<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QU·∫¢N TR·ªä VI√äN - SHOP B·∫ÆP</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <style>
        body { background: #0f172a; font-family: 'Quicksand', sans-serif; color: #fff; }
        .admin-card { background: rgba(30, 41, 59, 0.7); border: 1px solid rgba(255,255,255,0.1); border-radius: 15px; padding: 20px; }
        .status-badge { padding: 4px 10px; border-radius: 20px; font-size: 10px; font-weight: bold; text-transform: uppercase; }
        .pending { background: #f59e0b; color: #000; }
        .success { background: #10b981; color: #fff; }
        input { background: #1e293b; border: 1px solid #334155; color: #fff; padding: 5px 10px; border-radius: 8px; outline: none; }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-6xl mx-auto">
        <div class="flex justify-between items-center mb-8">
            <h1 class="text-2xl font-bold text-yellow-400 uppercase tracking-tighter">B·∫¢NG ƒêI·ªÄU KHI·ªÇN ADMIN üëë</h1>
            <button onclick="location.reload()" class="bg-blue-600 px-4 py-2 rounded-lg text-sm">L√†m m·ªõi d·ªØ li·ªáu</button>
        </div>

        <div class="grid grid-cols-1 gap-8">
            
            <section class="admin-card">
                <h2 class="text-lg mb-4 text-green-400">üí∞ Y√äU C·∫¶U N·∫†P TI·ªÄN (BANK/TH·∫∫)</h2>
                <div class="overflow-x-auto">
                    <table class="w-full text-left text-sm">
                        <thead class="border-b border-white/10 text-gray-400">
                            <tr>
                                <th class="p-3">Th·ªùi gian</th>
                                <th>Kh√°ch h√†ng</th>
                                <th>Lo·∫°i</th>
                                <th>Chi ti·∫øt</th>
                                <th>Tr·∫°ng th√°i</th>
                                <th>H√†nh ƒë·ªông</th>
                            </tr>
                        </thead>
                        <tbody id="list-requests"></tbody>
                    </table>
                </div>
            </section>

            <section class="admin-card border-t-4 border-yellow-500">
                <h2 class="text-lg mb-4 text-yellow-400">üõí ƒê∆†N H√ÄNG C·∫¶N X·ª¨ L√ù</h2>
                <div class="overflow-x-auto">
                    <table class="w-full text-left text-sm">
                        <thead class="border-b border-white/10 text-gray-400">
                            <tr>
                                <th class="p-3">Kh√°ch h√†ng</th>
                                <th>M√≥n ƒë·ªì / D·ªãch v·ª•</th>
                                <th>Th·ªùi gian</th>
                                <th>Tr·∫°ng th√°i</th>
                                <th>H√†nh ƒë·ªông</th>
                            </tr>
                        </thead>
                        <tbody id="list-orders"></tbody>
                    </table>
                </div>
            </section>

            <section class="admin-card">
                <h2 class="text-lg mb-4 text-purple-400">üë• QU·∫¢N L√ù TH√ÄNH VI√äN</h2>
                <div id="list-users" class="grid grid-cols-1 md:grid-cols-3 gap-4"></div>
            </section>
        </div>
    </div>

    <script>
        const firebaseConfig = { databaseURL: "https://shop-blox-fruit-trannghia-default-rtdb.firebaseio.com/" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // 1. T·∫¢I DANH S√ÅCH Y√äU C·∫¶U N·∫†P (REQUESTS)
        db.ref('requests').on('value', snapshot => {
            const data = snapshot.val();
            let html = '';
            for (let id in data) {
                const req = data[id];
                const isPending = req.status === 'Ch·ªù duy·ªát';
                html += `
                <tr class="border-b border-white/5 hover:bg-white/5">
                    <td class="p-3 opacity-50 text-[10px]">${req.time}</td>
                    <td class="font-bold">${req.user}</td>
                    <td><span class="status-badge bg-white/10">${req.type}</span></td>
                    <td class="text-[11px] text-gray-300">${req.info}</td>
                    <td><span class="status-badge ${isPending ? 'pending' : 'success'}">${req.status}</span></td>
                    <td class="p-2">
                        ${isPending ? `<button onclick="approveDeposit('${id}', '${req.user}', ${req.realVal || 0})" class="bg-green-600 px-3 py-1 rounded text-[10px] font-bold">C·ªòNG TI·ªÄN</button>` : '‚úÖ'}
                    </td>
                </tr>`;
            }
            document.getElementById('list-requests').innerHTML = html || '<tr><td colspan="6" class="text-center p-4 opacity-30">Kh√¥ng c√≥ y√™u c·∫ßu n√†o.</td></tr>';
        });

        // 2. T·∫¢I DANH S√ÅCH ƒê∆†N H√ÄNG (ORDERS)
        db.ref('orders').on('value', snapshot => {
            const data = snapshot.val();
            let html = '';
            for (let id in data) {
                const ord = data[id];
                const isProcessing = ord.status === 'ƒêang x·ª≠ l√Ω';
                html += `
                <tr class="border-b border-white/5 hover:bg-white/5">
                    <td class="p-3 font-bold text-yellow-400">${ord.user}</td>
                    <td>${ord.item}</td>
                    <td class="text-[10px] opacity-50">${ord.time}</td>
                    <td><span class="status-badge ${isProcessing ? 'pending' : 'success'}">${ord.status}</span></td>
                    <td class="p-2">
                        ${isProcessing ? `<button onclick="completeOrder('${id}')" class="bg-blue-600 px-3 py-1 rounded text-[10px] font-bold uppercase">Xong ‚úÖ</button>` : 'üëç'}
                    </td>
                </tr>`;
            }
            document.getElementById('list-orders').innerHTML = html || '<tr><td colspan="5" class="text-center p-4 opacity-30">Kh√¥ng c√≥ ƒë∆°n h√†ng.</td></tr>';
        });

        // 3. T·∫¢I DANH S√ÅCH NG∆Ø·ªúI D√ôNG
        db.ref('users').on('value', snapshot => {
            const data = snapshot.val();
            let html = '';
            for (let u in data) {
                const user = data[u];
                html += `
                <div class="bg-black/30 p-4 rounded-xl border border-white/5">
                    <p class="text-xs text-gray-400">@${u}</p>
                    <p class="text-lg font-bold text-green-400">${(user.balance || 0).toLocaleString()}ƒë</p>
                    <div class="mt-2 flex gap-2">
                        <input type="number" id="plus-${u}" placeholder="S·ªë ti·ªÅn..." class="w-full text-xs">
                        <button onclick="adjustBalance('${u}')" class="bg-white/10 px-2 rounded">S·ª≠a</button>
                    </div>
                </div>`;
            }
            document.getElementById('list-users').innerHTML = html;
        });

        // --- H√ÄM X·ª¨ L√ù LOGIC ---

        // Duy·ªát n·∫°p ti·ªÅn (C·ªông ti·ªÅn cho kh√°ch)
        async function approveDeposit(id, username, amount) {
            let money = amount;
            if(money <= 0) {
                money = prompt("Th·∫ª/Bank n√†y c·ªông bao nhi√™u ti·ªÅn?", "0");
                if(!money) return;
            }
            
            const userRef = db.ref('users/' + username);
            const snap = await userRef.get();
            const currentBal = snap.val().balance || 0;

            await userRef.update({ balance: currentBal + parseInt(money) });
            await db.ref('requests/' + id).update({ status: 'Ho√†n th√†nh' });
            alert(`ƒê√£ c·ªông ${parseInt(money).toLocaleString()}ƒë cho ${username}`);
        }

        // Ho√†n th√†nh ƒë∆°n h√†ng (L√†m xong ƒë·ªì/c√†y thu√™)
        async function completeOrder(id) {
            if(confirm("X√°c nh·∫≠n ƒë√£ l√†m xong ƒë∆°n n√†y?")) {
                await db.ref('orders/' + id).update({ status: 'Ho√†n th√†nh' });
                alert("ƒê√£ b√°o cho kh√°ch l√† xong!");
            }
        }

        // Ch·ªânh s·ª≠a s·ªë d∆∞ th·ªß c√¥ng
        async function adjustBalance(username) {
            const amount = document.getElementById('plus-' + username).value;
            if(!amount) return;
            await db.ref('users/' + username).update({ balance: parseInt(amount) });
            alert("ƒê√£ c·∫≠p nh·∫≠t s·ªë d∆∞!");
        }
    </script>
</body>
</html>
