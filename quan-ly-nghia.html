<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ADMIN - DUYỆT XONG TỰ MẤT</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');
        body { font-family: 'Inter', sans-serif; background: #0f172a; color: #e2e8f0; }
        .card-active { background: #1e293b; border: 1px solid #334155; border-left: 4px solid #3b82f6; }
        .btn-approve { background: linear-gradient(135deg, #10b981 0%, #059669 100%); transition: transform 0.2s; }
        .btn-approve:active { transform: scale(0.95); }
        .hidden-item { display: none !important; }
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
    </style>
</head>
<body class="p-4">

    <div class="max-w-5xl mx-auto">
        <header class="flex justify-between items-center mb-6">
            <div>
                <h1 class="text-xl font-black text-white uppercase tracking-widest">Quản Lý <span class="text-blue-500">Đơn Hàng</span></h1>
                <p class="text-slate-400 text-[10px]">Đơn duyệt xong sẽ tự động ẩn để tránh loạn</p>
            </div>
            <div id="conn-status" class="text-[10px] px-3 py-1 bg-slate-800 rounded-full border border-slate-700 font-mono">
                CONNECTING...
            </div>
        </header>

        <!-- Thanh điều hướng và Lọc -->
        <div class="flex flex-col sm:flex-row gap-4 justify-between items-center bg-slate-800/50 p-3 rounded-2xl border border-slate-700 mb-6">
            <div class="flex p-1 bg-slate-900 rounded-xl w-full sm:w-auto">
                <button onclick="changeTab('bank')" id="tab-bank" class="flex-1 sm:flex-none px-6 py-2 rounded-lg text-xs font-bold transition-all bg-blue-600 text-white">NẠP TIỀN</button>
                <button onclick="changeTab('orders')" id="tab-orders" class="flex-1 sm:flex-none px-6 py-2 rounded-lg text-xs font-bold transition-all text-slate-400">MUA ACC</button>
            </div>
            
            <div class="flex items-center gap-2 w-full sm:w-auto justify-end">
                <span class="text-[10px] font-bold text-slate-500">CHẾ ĐỘ:</span>
                <select id="view-mode" onchange="renderData()" class="bg-slate-900 border border-slate-700 text-[10px] font-bold rounded-lg px-3 py-2 text-blue-400 focus:outline-none">
                    <option value="pending">CHƯA XỬ LÝ (ẨN ĐÃ XONG)</option>
                    <option value="all">HIỆN TẤT CẢ (LỊCH SỬ)</option>
                </select>
            </div>
        </div>

        <!-- Danh sách -->
        <div id="list-container" class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <!-- Dữ liệu load tại đây -->
        </div>

        <!-- Thông báo trống -->
        <div id="empty-state" class="hidden py-20 text-center">
            <i class="fas fa-check-circle text-4xl text-slate-700 mb-3"></i>
            <p class="text-slate-500 font-bold italic">Sạch sẽ! Không còn đơn nào cần duyệt.</p>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            databaseURL: "https://shop-blox-fruit-trannghia-default-rtdb.firebaseio.com/"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let currentTab = 'bank'; // 'bank' hoặc 'orders'
        let dataStore = { bank: {}, orders: {} };

        // Kết nối
        db.ref(".info/connected").on("value", (s) => {
            const el = document.getElementById('conn-status');
            el.innerHTML = s.val() ? '<span class="text-emerald-400">● ONLINE</span>' : '<span class="text-red-500">● OFFLINE</span>';
        });

        // Lấy dữ liệu Realtime
        function startSync() {
            // Nạp tiền
            db.ref('requests').on('value', (s) => {
                dataStore.bank = s.val() || {};
                if(currentTab === 'bank') renderData();
            });

            // Mua hàng
            db.ref('orders').on('value', (s) => {
                dataStore.orders = s.val() || {};
                if(currentTab === 'orders') renderData();
            });
        }

        function renderData() {
            const container = document.getElementById('list-container');
            const emptyState = document.getElementById('empty-state');
            const mode = document.getElementById('view-mode').value;
            container.innerHTML = "";

            const currentData = dataStore[currentTab];
            const keys = Object.keys(currentData).reverse();
            let visibleCount = 0;

            keys.forEach(key => {
                const item = currentData[key];
                const isDone = (item.status === 'completed' || item.status === 'done');

                // Logic chính: Nếu chế độ là 'pending' mà đơn đã xong thì bỏ qua
                if(mode === 'pending' && isDone) return;

                visibleCount++;
                const card = document.createElement('div');
                card.className = `card-active p-4 rounded-xl flex flex-col justify-between animate-in slide-in-from-bottom-2 duration-300`;
                
                if(currentTab === 'bank') {
                    card.innerHTML = `
                        <div>
                            <div class="flex justify-between items-start mb-2">
                                <span class="text-[9px] text-slate-500 font-mono">#${key.slice(-5)}</span>
                                <span class="text-[9px] font-bold px-2 py-0.5 rounded ${isDone ? 'bg-emerald-900 text-emerald-400' : 'bg-amber-900/50 text-amber-400'}">${isDone ? 'ĐÃ DUYỆT' : 'CHỜ NẠP'}</span>
                            </div>
                            <h3 class="text-white font-bold text-sm">Khách: @${item.user || 'N/A'}</h3>
                            <div class="text-xl font-black text-emerald-400 my-2">${Number(item.amount || 0).toLocaleString()}đ</div>
                            <div class="text-[10px] text-slate-400 bg-slate-900 p-2 rounded italic">"${item.memo || 'Nạp tiền'}"</div>
                        </div>
                        ${!isDone ? `<button onclick="handleApproveBank('${key}', '${item.user}', ${item.amount})" class="btn-approve w-full mt-4 py-2 rounded-lg text-[11px] font-bold text-white uppercase tracking-wider">Xác nhận nạp xong</button>` : ''}
                    `;
                } else {
                    card.innerHTML = `
                        <div>
                            <div class="flex justify-between items-start mb-2">
                                <span class="text-[9px] text-slate-500 font-mono">MUA ACC</span>
                                <span class="text-[9px] font-bold px-2 py-0.5 rounded ${isDone ? 'bg-emerald-900 text-emerald-400' : 'bg-blue-900/50 text-blue-400'}">${isDone ? 'XONG' : 'MỚI'}</span>
                            </div>
                            <h3 class="text-white font-bold text-sm truncate">${item.item || 'Sản phẩm'}</h3>
                            <div class="mt-2 p-2 bg-black/40 rounded border border-slate-700">
                                <p class="text-[9px] text-slate-500 mb-1">Tài khoản | Mật khẩu:</p>
                                <p class="text-xs font-mono text-blue-300 break-all select-all">${item.info || 'N/A'}</p>
                            </div>
                        </div>
                        <div class="flex gap-2 mt-4">
                            ${!isDone ? `<button onclick="handleDoneOrder('${key}')" class="flex-1 bg-blue-600 py-2 rounded-lg text-[11px] font-bold text-white uppercase">Giao xong</button>` : ''}
                            <button onclick="handleDelete('${currentTab === 'bank' ? 'requests' : 'orders'}', '${key}')" class="px-4 bg-slate-700 hover:bg-red-900 rounded-lg text-slate-400 hover:text-white transition-colors"><i class="fas fa-trash-alt text-xs"></i></button>
                        </div>
                    `;
                }
                container.appendChild(card);
            });

            if(visibleCount === 0) {
                emptyState.classList.remove('hidden');
            } else {
                emptyState.classList.add('hidden');
            }
        }

        // Logic duyệt Nạp tiền
        async function handleApproveBank(key, username, amount) {
            try {
                // 1. Cộng tiền vào user
                const userRef = db.ref('users/' + username);
                const userSnap = await userRef.once('value');
                const currentBalance = (userSnap.val()?.balance || 0);
                await userRef.update({ balance: currentBalance + Number(amount) });

                // 2. Đánh dấu đã xong (nó sẽ tự ẩn khỏi giao diện nhờ renderData filter)
                await db.ref('requests/' + key).update({ status: 'completed' });
                console.log("Duyệt thành công: " + key);
            } catch (err) {
                alert("Lỗi: " + err.message);
            }
        }

        // Logic duyệt Đơn hàng
        async function handleDoneOrder(key) {
            await db.ref('orders/' + key).update({ status: 'completed' });
        }

        // Xóa hẳn đơn
        async function handleDelete(path, key) {
            if(confirm("Xóa vĩnh viễn đơn này khỏi database?")) {
                await db.ref(path + '/' + key).remove();
            }
        }

        // Chuyển Tab
        function changeTab(tab) {
            currentTab = tab;
            document.getElementById('tab-bank').className = tab === 'bank' ? "flex-1 sm:flex-none px-6 py-2 rounded-lg text-xs font-bold transition-all bg-blue-600 text-white" : "flex-1 sm:flex-none px-6 py-2 rounded-lg text-xs font-bold transition-all text-slate-400";
            document.getElementById('tab-orders').className = tab === 'orders' ? "flex-1 sm:flex-none px-6 py-2 rounded-lg text-xs font-bold transition-all bg-blue-600 text-white" : "flex-1 sm:flex-none px-6 py-2 rounded-lg text-xs font-bold transition-all text-slate-400";
            renderData();
        }

        startSync();
    </script>
</body>
</html>
