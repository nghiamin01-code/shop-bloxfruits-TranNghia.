<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ADMIN - DUYỆT NẠP TIỀN</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: #0b0f1a; color: #f8fafc; }
        .glass-card { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.05); }
        .status-pending { background: rgba(245, 158, 11, 0.1); color: #fbbf24; border: 1px solid rgba(245, 158, 11, 0.2); }
        .status-done { background: rgba(16, 185, 129, 0.1); color: #34d399; border: 1px solid rgba(16, 185, 129, 0.2); }
        .btn-confirm { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); box-shadow: 0 4px 15px rgba(37, 99, 235, 0.3); }
        .loading-shimmer { background: linear-gradient(90deg, #1e293b 25%, #334155 50%, #1e293b 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite; }
        @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
    </style>
</head>
<body class="min-h-screen pb-10">

    <div class="max-w-4xl mx-auto px-4 pt-8">
        <!-- Header -->
        <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-8">
            <div>
                <h1 class="text-2xl font-extrabold tracking-tight italic">BANKING <span class="text-blue-500 italic">CONTROL</span></h1>
                <p class="text-slate-400 text-xs mt-1">Hệ thống duyệt nạp tiền tự động ẩn khi hoàn tất</p>
            </div>
            <div id="connection-badge" class="flex items-center gap-2 px-3 py-1.5 rounded-full bg-slate-900 border border-slate-800 text-[10px] font-bold">
                <span class="w-2 h-2 rounded-full bg-slate-500 animate-pulse"></span>
                ĐANG KẾT NỐI...
            </div>
        </div>

        <!-- Toolbar -->
        <div class="flex flex-wrap items-center justify-between gap-4 mb-6 p-4 glass-card rounded-2xl">
            <div class="flex gap-2">
                <button onclick="refreshData()" class="p-2 bg-slate-800 rounded-lg hover:bg-slate-700 transition-colors">
                    <i class="fas fa-sync-alt text-sm"></i>
                </button>
                <div class="h-8 w-[1px] bg-slate-700 mx-1"></div>
                <select id="filter-status" onchange="renderUI()" class="bg-slate-800 border-none text-xs font-bold rounded-lg px-3 py-2 outline-none cursor-pointer">
                    <option value="pending">CHƯA DUYỆT (ẨN KHI XONG)</option>
                    <option value="all">TẤT CẢ LỊCH SỬ</option>
                </select>
            </div>
            <div class="text-right">
                <span id="counter" class="text-[10px] font-mono text-blue-400 bg-blue-500/10 px-2 py-1 rounded">Đang tải...</span>
            </div>
        </div>

        <!-- List Content -->
        <div id="bank-list" class="grid gap-3">
            <!-- Items load here -->
            <div class="loading-shimmer h-24 rounded-2xl"></div>
            <div class="loading-shimmer h-24 rounded-2xl opacity-50"></div>
        </div>

        <!-- Empty State -->
        <div id="empty-state" class="hidden flex flex-col items-center justify-center py-20 text-slate-500">
            <i class="fas fa-check-double text-5xl mb-4 opacity-20"></i>
            <p class="font-bold tracking-wide">KHÔNG CÓ ĐƠN NÀO ĐANG CHỜ</p>
            <p class="text-[10px] mt-1 opacity-60">Mọi thứ đã được xử lý sạch sẽ!</p>
        </div>
    </div>

    <!-- Notification Toast -->
    <div id="toast" class="fixed bottom-5 right-5 transform translate-y-20 opacity-0 transition-all duration-300 px-6 py-3 rounded-xl glass-card border-blue-500/50 flex items-center gap-3 z-50">
        <div class="w-8 h-8 rounded-full bg-blue-500/20 flex items-center justify-center">
            <i class="fas fa-info-circle text-blue-500"></i>
        </div>
        <p id="toast-msg" class="text-xs font-bold"></p>
    </div>

    <script>
        const firebaseConfig = {
            databaseURL: "https://shop-blox-fruit-trannghia-default-rtdb.firebaseio.com/"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let bankRequests = [];

        // 1. Sync Data Realtime
        function initRealtime() {
            // Lắng nghe nhánh requests (thường dùng cho nạp thẻ/bank)
            db.ref('requests').on('value', (snapshot) => {
                const data = snapshot.val() || {};
                bankRequests = Object.keys(data).map(key => ({
                    id: key,
                    ...data[key],
                    dbPath: 'requests'
                }));
                renderUI();
            });

            // Lắng nghe kết nối
            db.ref(".info/connected").on("value", (snap) => {
                const badge = document.getElementById('connection-badge');
                if (snap.val() === true) {
                    badge.innerHTML = '<span class="w-2 h-2 rounded-full bg-emerald-500"></span> ONLINE';
                    badge.classList.add('text-emerald-500');
                } else {
                    badge.innerHTML = '<span class="w-2 h-2 rounded-full bg-red-500"></span> OFFLINE';
                    badge.classList.add('text-red-500');
                }
            });
        }

        // 2. Render UI
        function renderUI() {
            const listEl = document.getElementById('bank-list');
            const filter = document.getElementById('filter-status').value;
            const emptyEl = document.getElementById('empty-state');
            const counterEl = document.getElementById('counter');
            
            listEl.innerHTML = "";

            // Lọc dữ liệu: Nếu là 'pending' thì chỉ hiện đơn chưa hoàn thành
            const filteredData = bankRequests.filter(item => {
                const isDone = (item.status === 'completed' || item.status === 'done' || item.status === 1);
                if (filter === 'pending') return !isDone;
                return true;
            }).reverse();

            counterEl.innerText = `CÓ ${filteredData.length} ĐƠN`;

            if (filteredData.length === 0) {
                emptyEl.classList.remove('hidden');
            } else {
                emptyEl.classList.add('hidden');
                filteredData.forEach(item => {
                    const isDone = (item.status === 'completed' || item.status === 'done' || item.status === 1);
                    const div = document.createElement('div');
                    div.className = "p-5 glass-card rounded-2xl flex flex-col md:flex-row justify-between items-center gap-4 transition-all hover:border-slate-600";
                    
                    div.innerHTML = `
                        <div class="flex-1 w-full">
                            <div class="flex items-center gap-3 mb-2">
                                <span class="text-[10px] font-mono text-slate-500">ID: ${item.id.slice(-6)}</span>
                                <span class="px-2 py-0.5 rounded text-[9px] font-bold uppercase ${isDone ? 'status-done' : 'status-pending'}">
                                    ${isDone ? 'Đã duyệt' : 'Đang chờ'}
                                </span>
                            </div>
                            <div class="flex items-baseline gap-2">
                                <span class="text-xl font-black text-blue-400">${Number(item.amount || 0).toLocaleString()}</span>
                                <span class="text-[10px] font-bold text-slate-500 tracking-widest">VNĐ</span>
                            </div>
                            <div class="mt-2 flex flex-col gap-1">
                                <p class="text-xs font-bold text-slate-300"><i class="far fa-user mr-2 text-slate-500"></i>${item.user || 'Ẩn danh'}</p>
                                <p class="text-[10px] text-slate-500 italic bg-black/20 p-2 rounded-lg border border-white/5 mt-1">"${item.memo || item.content || 'Nạp tiền vào tài khoản'}"</p>
                            </div>
                        </div>
                        <div class="flex gap-2 w-full md:w-auto">
                            ${!isDone ? `
                                <button onclick="approveDeposit('${item.id}', '${item.user}', ${item.amount})" class="btn-confirm flex-1 md:flex-none px-6 py-3 rounded-xl text-xs font-black tracking-widest text-white uppercase transition-all active:scale-95">
                                    Xác nhận nạp
                                </button>
                            ` : ''}
                            <button onclick="deleteRequest('${item.id}')" class="p-3 rounded-xl bg-slate-800 text-slate-500 hover:text-red-400 transition-colors">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </div>
                    `;
                    listEl.appendChild(div);
                });
            }
        }

        // 3. Logic Duyệt Tiền (Cộng số dư + Đổi trạng thái)
        async function approveDeposit(id, username, amount) {
            try {
                if(!username) {
                    showToast("Lỗi: Không tìm thấy tên người dùng!");
                    return;
                }

                // A. Cộng tiền vào ví user
                const userRef = db.ref('users/' + username);
                const snapshot = await userRef.once('value');
                const userData = snapshot.val();
                
                if (userData) {
                    const currentBalance = Number(userData.balance || 0);
                    const newBalance = currentBalance + Number(amount);
                    await userRef.update({ balance: newBalance });
                } else {
                    showToast("Cảnh báo: User không tồn tại nhưng vẫn duyệt trạng thái...");
                }

                // B. Cập nhật trạng thái đơn nạp -> TỰ ĐỘNG BIẾN MẤT KHỎI LIST
                await db.ref('requests/' + id).update({ 
                    status: 'completed',
                    processedAt: Date.now()
                });

                showToast(`Đã nạp +${Number(amount).toLocaleString()}đ cho ${username}`);
            } catch (error) {
                console.error(error);
                showToast("Lỗi hệ thống Firebase!");
            }
        }

        // 4. Xóa yêu cầu
        async function deleteRequest(id) {
            if(confirm("Bạn có chắc chắn muốn xóa đơn này vĩnh viễn?")) {
                await db.ref('requests/' + id).remove();
                showToast("Đã xóa yêu cầu.");
            }
        }

        function showToast(msg) {
            const toast = document.getElementById('toast');
            document.getElementById('toast-msg').innerText = msg;
            toast.classList.remove('translate-y-20', 'opacity-0');
            setTimeout(() => {
                toast.classList.add('translate-y-20', 'opacity-0');
            }, 3000);
        }

        function refreshData() {
            showToast("Đang đồng bộ dữ liệu...");
            renderUI();
        }

        // Chạy hệ thống
        initRealtime();
    </script>
</body>
</html>
