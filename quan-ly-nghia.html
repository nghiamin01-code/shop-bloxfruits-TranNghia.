<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hệ Thống Shop Game Tích Hợp</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .active-tab { border-bottom: 3px solid #3b82f6; color: #3b82f6; }
        .status-pending { background: #fef3c7; color: #92400e; }
        .status-completed { background: #dcfce7; color: #166534; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">

    <!-- NAVIGATION -->
    <nav class="bg-white shadow-md p-4 flex justify-between items-center sticky top-0 z-50">
        <div class="flex gap-6 font-bold">
            <button onclick="switchView('user')" id="btn-user" class="active-tab px-4 py-2">Mặt Cửa Hàng (User)</button>
            <button onclick="switchView('admin')" id="btn-admin" class="px-4 py-2 text-red-600">Quản Trị (Admin)</button>
        </div>
        <div id="user-info" class="text-sm font-semibold text-blue-600">
            Số dư: <span id="my-balance">0</span>đ
        </div>
    </nav>

    <!-- ================= USER VIEW ================= -->
    <div id="view-user" class="container mx-auto p-6">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <!-- Form Nạp Tiền -->
            <div class="bg-white p-6 rounded-xl shadow">
                <h3 class="text-xl font-bold mb-4 border-b pb-2"><i class="fas fa-university mr-2"></i>Nạp Tiền Qua Bank</h3>
                <div class="space-y-4">
                    <input type="number" id="nap-amount" placeholder="Nhập số tiền muốn nạp" class="w-full border p-3 rounded">
                    <input type="text" id="nap-content" placeholder="Mã giao dịch hoặc nội dung" class="w-full border p-3 rounded">
                    <button onclick="orderNapBank()" class="w-full bg-blue-600 text-white py-3 rounded-lg font-bold hover:bg-blue-700 transition">GỬI YÊU CẦU NẠP</button>
                </div>
            </div>

            <!-- Form Cày Thuê -->
            <div class="bg-white p-6 rounded-xl shadow">
                <h3 class="text-xl font-bold mb-4 border-b pb-2"><i class="fas fa-hammer mr-2"></i>Đặt Đơn Cày Thuê</h3>
                <div class="space-y-4">
                    <select id="cay-service" class="w-full border p-3 rounded">
                        <option value="Cày Level Blox Fruit">Cày Level Blox Fruit - 50.000đ</option>
                        <option value="Săn Bounty 5M">Săn Bounty 5M - 100.000đ</option>
                        <option value="Lấy Song Kiếm Oden">Lấy Song Kiếm Oden - 150.000đ</option>
                    </select>
                    <div class="grid grid-cols-2 gap-2">
                        <input type="text" id="cay-user" placeholder="Tài khoản Game" class="border p-3 rounded">
                        <input type="text" id="cay-pass" placeholder="Mật khẩu Game" class="border p-3 rounded">
                    </div>
                    <textarea id="cay-note" placeholder="Lưu ý cho Admin (Mã 2FA...)" class="w-full border p-3 rounded"></textarea>
                    <button onclick="orderCayThue()" class="w-full bg-orange-500 text-white py-3 rounded-lg font-bold hover:bg-orange-600 transition">THANH TOÁN & ĐẶT ĐƠN</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ================= ADMIN VIEW ================= -->
    <div id="view-admin" class="container mx-auto p-6 hidden">
        <div class="space-y-8">
            <!-- Quản lý Nạp Bank -->
            <div class="bg-white rounded-xl shadow overflow-hidden">
                <div class="bg-slate-800 text-white p-4 font-bold">DANH SÁCH DUYỆT NẠP BANK</div>
                <table class="w-full text-left">
                    <thead class="bg-gray-100 text-xs font-bold uppercase">
                        <tr>
                            <th class="p-4">Nội dung</th>
                            <th class="p-4">Số tiền</th>
                            <th class="p-4">Trạng thái</th>
                            <th class="p-4">Thao tác</th>
                        </tr>
                    </thead>
                    <tbody id="admin-bank-list" class="divide-y text-sm"></tbody>
                </table>
            </div>

            <!-- Quản lý Cày Thuê -->
            <div class="bg-white rounded-xl shadow overflow-hidden">
                <div class="bg-slate-800 text-white p-4 font-bold">QUẢN LÝ ĐƠN CÀY THUÊ</div>
                <table class="w-full text-left">
                    <thead class="bg-gray-100 text-xs font-bold uppercase">
                        <tr>
                            <th class="p-4">Dịch vụ</th>
                            <th class="p-4">Tài khoản/Mật khẩu</th>
                            <th class="p-4">Ghi chú</th>
                            <th class="p-4">Trạng thái</th>
                            <th class="p-4">Thao tác</th>
                        </tr>
                    </thead>
                    <tbody id="admin-cay-list" class="divide-y text-sm"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // --- 1. CẤU HÌNH FIREBASE ---
        // Thay link database của bạn vào đây
        const firebaseConfig = {
            databaseURL: "https://shop-blox-fruit-trannghia-default-rtdb.firebaseio.com/"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // Giả lập User hiện tại (Trong thực tế sẽ dùng Auth)
        const currentUser = "KhachHang_01";

        // --- 2. XỬ LÝ CHUYỂN VIEW ---
        function switchView(view) {
            document.getElementById('view-user').classList.toggle('hidden', view !== 'user');
            document.getElementById('view-admin').classList.toggle('hidden', view !== 'admin');
            document.getElementById('btn-user').classList.toggle('active-tab', view === 'user');
            document.getElementById('btn-admin').classList.toggle('active-tab', view === 'admin');
        }

        // --- 3. LOGIC NGƯỜI DÙNG (GỬI DỮ LIỆU) ---

        // Gửi yêu cầu nạp tiền
        function orderNapBank() {
            const amount = document.getElementById('nap-amount').value;
            const content = document.getElementById('nap-content').value;

            if(!amount || !content) return alert("Vui lòng nhập đủ thông tin");

            const newOrder = {
                username: currentUser,
                amount: parseInt(amount),
                content: content,
                status: 'pending',
                time: new Date().toLocaleString()
            };

            // Gửi vào nhánh 'nap_bank'
            db.ref('nap_bank').push(newOrder).then(() => {
                alert("Đã gửi yêu cầu nạp! Vui lòng chờ Admin duyệt.");
                document.getElementById('nap-amount').value = "";
                document.getElementById('nap-content').value = "";
            });
        }

        // Gửi đơn cày thuê
        function orderCayThue() {
            const service = document.getElementById('cay-service').value;
            const user = document.getElementById('cay-user').value;
            const pass = document.getElementById('cay-pass').value;
            const note = document.getElementById('cay-note').value;

            if(!user || !pass) return alert("Nhập tài khoản mật khẩu game");

            const newOrder = {
                username: currentUser,
                service_name: service,
                game_user: user,
                game_pass: pass,
                note: note,
                status: 'pending'
            };

            db.ref('cay_thue').push(newOrder).then(() => {
                alert("Đặt đơn thành công! Admin sẽ sớm thực hiện.");
                document.getElementById('cay-user').value = "";
                document.getElementById('cay-pass').value = "";
            });
        }

        // --- 4. LOGIC ADMIN (NHẬN DỮ LIỆU & DUYỆT) ---

        // Lắng nghe đơn nạp Bank
        db.ref('nap_bank').on('value', snapshot => {
            const list = document.getElementById('admin-bank-list');
            list.innerHTML = "";
            snapshot.forEach(child => {
                const item = child.val();
                const id = child.key;
                list.innerHTML += `
                    <tr class="hover:bg-gray-50">
                        <td class="p-4"><b>${item.username}</b><br><span class="text-xs text-gray-400">${item.content}</span></td>
                        <td class="p-4 text-green-600 font-bold">${item.amount.toLocaleString()}đ</td>
                        <td class="p-4"><span class="px-2 py-1 rounded text-xs font-bold status-${item.status}">${item.status}</span></td>
                        <td class="p-4">
                            ${item.status === 'pending' ? `
                                <button onclick="approveBank('${id}', '${item.username}', ${item.amount})" class="bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600">Duyệt</button>
                                <button onclick="deleteItem('nap_bank', '${id}')" class="text-red-500 ml-2">Xóa</button>
                            ` : '<span class="text-gray-400">Đã xong</span>'}
                        </td>
                    </tr>
                `;
            });
        });

        // Lắng nghe đơn Cày Thuê
        db.ref('cay_thue').on('value', snapshot => {
            const list = document.getElementById('admin-cay-list');
            list.innerHTML = "";
            snapshot.forEach(child => {
                const item = child.val();
                const id = child.key;
                list.innerHTML += `
                    <tr class="hover:bg-gray-50">
                        <td class="p-4 font-semibold">${item.service_name}</td>
                        <td class="p-4 font-mono text-xs">U: ${item.game_user}<br>P: ${item.game_pass}</td>
                        <td class="p-4 text-xs italic">${item.note || ''}</td>
                        <td class="p-4"><span class="px-2 py-1 rounded text-xs font-bold status-${item.status}">${item.status}</span></td>
                        <td class="p-4">
                             <select onchange="updateStatus('cay_thue', '${id}', this.value)" class="border p-1 rounded text-xs">
                                <option value="pending" ${item.status === 'pending' ? 'selected' : ''}>Chờ</option>
                                <option value="processing" ${item.status === 'processing' ? 'selected' : ''}>Đang cày</option>
                                <option value="completed" ${item.status === 'completed' ? 'selected' : ''}>Xong</option>
                            </select>
                        </td>
                    </tr>
                `;
            });
        });

        // --- 5. HÀM XỬ LÝ NGHIỆP VỤ ---

        // Duyệt nạp tiền và cộng vào số dư User
        function approveBank(id, user, amount) {
            // Cập nhật trạng thái đơn
            db.ref('nap_bank/' + id).update({ status: 'completed' });
            
            // Cộng tiền vào tài khoản User
            const balanceRef = db.ref('users/' + user + '/balance');
            balanceRef.get().then(snap => {
                const current = snap.val() || 0;
                balanceRef.set(current + amount);
                alert("Đã duyệt & cộng tiền thành công cho " + user);
            });
        }

        // Cập nhật trạng thái
        function updateStatus(path, id, status) {
            db.ref(path + '/' + id).update({ status: status });
        }

        // Xóa đơn (Nếu cần dọn dẹp)
        function deleteItem(path, id) {
            if(confirm("Chắc chắn xóa?")) db.ref(path + '/' + id).remove();
        }

        // Hiển thị số dư thực tế của User (Lấy từ Firebase)
        db.ref('users/' + currentUser + '/balance').on('value', snap => {
            document.getElementById('my-balance').innerText = (snap.val() || 0).toLocaleString();
        });

    </script>
</body>
</html>
